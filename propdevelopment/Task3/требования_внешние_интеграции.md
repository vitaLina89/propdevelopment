# Требования к внешним интеграциям: Партнёр "Умный дом"

## 1. Общая информация

**Партнёр**: Партнёр "Умный дом"  
**Дата документа**: 2025-01-07  
**Версия**: 1.0

### 1.1. Описание интеграции

PropDevelopment интегрируется с внешней платформой партнёра для предоставления следующих сервисов:

1. **Интеллектуальный домофон**
   - Функции классического видеодомофона (открытие по звонку)
   - Распознавание пользователей по биометрии (по лицу)
   - Автоматическое открытие двери при разрешённом доступе

2. **Интеллектуальный шлагбаум**
   - Функции классического управления шлагбаумом
   - Автоматическое открытие при распознавании номеров автомобилей с разрешённым доступом

### 1.2. Точки интеграции

- **Мобильное приложение PropDevelopment** → **Партнёр "Умный дом"** (управление доступом и настройками)
- **Партнёр "Умный дом"** → **PropDevelopment** (события доступа и распознавания)

---

## 2. Требования к безопасности

### 2.1. Классификация данных

#### 2.1.1. Конфиденциальные данные
- Персональные данные собственников и жильцов (ФИО, телефон, email)
- Биометрические данные (шаблоны лиц для распознавания)
- Номера автомобилей и привязка к собственникам
- Настройки доступа (разрешения на вход в дом/парковку)
- Идентификаторы объектов недвижимости и квартир

#### 2.1.2. Секретные данные
- API ключи и токены доступа к внешней платформе
- Закрытые ключи для подписи запросов
- Учётные данные для аутентификации в системе партнёра

### 2.2. Требования к защите данных

#### 2.2.1. Шифрование в транзите
- **Обязательное использование TLS 1.2+** для всех HTTP/HTTPS соединений
- **Минимальная версия TLS**: 1.2 (рекомендуется TLS 1.3)
- **Валидация сертификатов**: обязательная проверка сертификатов сервера партнёра
- **Perfect Forward Secrecy (PFS)**: использование эфемерных ключей для сессий
- **Запрет устаревших протоколов**: отключение SSL 3.0, TLS 1.0, TLS 1.1

#### 2.2.2. Шифрование на хранении
- **Биометрические данные**: должны храниться в зашифрованном виде (AES-256)
- **API ключи и токены**: хранение в защищённом хранилище секретов (Vault, AWS Secrets Manager, Azure Key Vault)
- **База данных**: шифрование чувствительных полей в БД (например, номера автомобилей)
- **Бэкапы**: все бэкапы должны быть зашифрованы

#### 2.2.3. Защита от утечек данных
- **Минимизация передаваемых данных**: передавать только необходимые атрибуты
- **Маскирование данных в логах**: не логировать биометрические данные, полные номера автомобилей
- **Контроль доступа**: принцип наименьших привилегий (least privilege)
- **DLP (Data Loss Prevention)**: мониторинг каналов передачи данных

### 2.3. Целостность данных

#### 2.3.1. Подпись запросов
- **Цифровая подпись**: все запросы к API партнёра должны быть подписаны
- **Алгоритм подписи**: HMAC-SHA256 или RSA-SHA256
- **Валидация ответов**: проверка подписи всех ответов от партнёра

#### 2.3.2. Защита от подмены
- **Nonce/Timestamp**: использование одноразовых значений и временных меток для предотвращения replay-атак
- **Валидация источника**: проверка IP-адресов и доменных имён
- **Rate limiting**: ограничение частоты запросов для предотвращения атак

### 2.4. Доступность и отказоустойчивость

#### 2.4.1. Требования к SLA
- **Доступность API партнёра**: минимум 99.5% (uptime)
- **Время отклика**: среднее время ответа API не более 500 мс (p95 < 1 сек)
- **План восстановления**: максимальное время восстановления (RTO) не более 4 часов

#### 2.4.2. Обработка сбоев
- **Retry механизм**: автоматические повторы с экспоненциальной задержкой
- **Circuit breaker**: разрыв соединения при множественных ошибках
- **Fallback механизмы**: резервные способы управления доступом при недоступности API
- **Очередь сообщений**: буферизация событий при временной недоступности

### 2.5. Аудит и мониторинг

#### 2.5.1. Логирование
- **Все операции с доступом**: логирование всех запросов на открытие двери/шлагбаума
- **События распознавания**: логирование успешных и неуспешных попыток распознавания
- **Изменения настроек**: аудит всех изменений прав доступа
- **Ошибки и исключения**: детальное логирование всех ошибок интеграции

#### 2.5.2. Мониторинг безопасности
- **Аномальные паттерны**: обнаружение подозрительной активности (множественные неудачные попытки доступа)
- **Алерты**: уведомления о критических событиях безопасности
- **Метрики**: отслеживание количества запросов, ошибок, времени отклика

---

## 3. Протоколы аутентификации и авторизации

### 3.1. Аутентификация

#### 3.1.1. OAuth 2.0 / OIDC
**Рекомендуемый протокол**: OAuth 2.0 с использованием OpenID Connect (OIDC)

**Параметры**:
- **Grant Type**: Client Credentials (для сервер-сервер взаимодействия)
- **Token Endpoint**: предоставляется партнёром
- **Scope**: `smart-home:read`, `smart-home:write`, `smart-home:admin`
- **Token Lifetime**: 
  - Access Token: 1 час (максимум)
  - Refresh Token: 30 дней (если используется)

**Процесс аутентификации**:
1. PropDevelopment отправляет запрос на получение токена с использованием Client ID и Client Secret
2. Партнёр возвращает Access Token и Refresh Token (опционально)
3. Access Token используется для всех последующих запросов к API
4. При истечении Access Token используется Refresh Token для получения нового

#### 3.1.2. Альтернативный вариант: API Key + HMAC
Если OAuth 2.0 недоступен, используется комбинация:
- **API Key**: уникальный идентификатор клиента
- **HMAC подпись**: подпись каждого запроса с использованием секретного ключа
- **Алгоритм**: HMAC-SHA256
- **Параметры подписи**: timestamp, nonce, метод, путь, тело запроса

### 3.2. Авторизация

#### 3.2.1. Ролевая модель доступа (RBAC)

**Роли в системе PropDevelopment**:
- **Собственник**: полный доступ к управлению доступом для своих объектов
- **Жилец**: ограниченный доступ (только просмотр статуса доступа)
- **Администратор**: полный доступ ко всем объектам и настройкам

**Роли в системе партнёра**:
- **API Client**: базовые права на чтение и запись данных
- **Admin**: расширенные права на управление устройствами

#### 3.2.2. Принцип наименьших привилегий
- Каждый запрос должен содержать только необходимые права доступа
- Проверка прав на уровне каждого API endpoint
- Изоляция данных между разными объектами недвижимости

#### 3.2.3. Валидация доступа
- **Проверка владения**: собственник может управлять доступом только для своих объектов
- **Проверка резидентства**: жилец может просматривать только свой статус доступа
- **Валидация на стороне партнёра**: партнёр должен проверять права доступа перед выполнением операций

### 3.3. Управление сессиями

#### 3.3.1. Токены доступа
- **Формат**: JWT (JSON Web Token) или opaque token
- **Структура JWT** (если используется):
  ```json
  {
    "iss": "partner-smart-home",
    "sub": "propdev-client-id",
    "aud": "smart-home-api",
    "exp": 1234567890,
    "iat": 1234567890,
    "scope": "smart-home:read smart-home:write",
    "client_id": "propdev-client-id"
  }
  ```
- **Подпись**: RS256 или HS256

#### 3.3.2. Обновление токенов
- **Автоматическое обновление**: перед истечением срока действия
- **Обработка истечения**: graceful handling с автоматическим refresh
- **Инвалидация**: возможность отзыва токенов при компрометации

---

## 4. Организация взаимодействия между системами

### 4.1. Архитектура взаимодействия

```
┌─────────────────────────────────┐
│  Мобильное приложение           │
│  PropDevelopment                │
│  (iOS/Android)                  │
└──────────────┬──────────────────┘
               │ REST API
               │ (HTTPS)
               ▼
┌─────────────────────────────────┐
│  Smart Home Service             │
│  (PropDevelopment)             │
│  - Управление доступом          │
│  - Синхронизация настроек       │
│  - Обработка событий            │
└──────────────┬──────────────────┘
               │ REST API
               │ (HTTPS, OAuth 2.0)
               ▼
┌─────────────────────────────────┐
│  Партнёр "Умный дом"            │
│  - API Gateway                  │
│  - Сервис распознавания         │
│  - Управление устройствами      │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  Устройства                     │
│  - Интеллектуальный домофон     │
│  - Интеллектуальный шлагбаум    │
└─────────────────────────────────┘
```

### 4.2. Направления взаимодействия

#### 4.2.1. PropDevelopment → Партнёр "Умный дом"

**Типы запросов**:

1. **Управление доступом**
   - `POST /api/v1/access/permissions` - создание/обновление разрешений доступа
   - `DELETE /api/v1/access/permissions/{id}` - удаление разрешения
   - `GET /api/v1/access/permissions` - получение списка разрешений

2. **Управление биометрией**
   - `POST /api/v1/biometry/faces` - загрузка биометрических данных (шаблон лица)
   - `DELETE /api/v1/biometry/faces/{id}` - удаление биометрических данных
   - `GET /api/v1/biometry/faces` - получение списка зарегистрированных лиц

3. **Управление номерами автомобилей**
   - `POST /api/v1/vehicles/plates` - регистрация номера автомобиля
   - `DELETE /api/v1/vehicles/plates/{id}` - удаление номера
   - `GET /api/v1/vehicles/plates` - получение списка номеров

4. **Управление устройствами**
   - `POST /api/v1/devices/{deviceId}/open` - команда на открытие двери/шлагбаума
   - `GET /api/v1/devices/{deviceId}/status` - получение статуса устройства

**Формат данных**:
- **Content-Type**: `application/json`
- **Кодировка**: UTF-8
- **Формат даты/времени**: ISO 8601 (например, `2025-01-07T10:30:00Z`)

**Пример запроса**:
```json
POST /api/v1/access/permissions
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "property_id": "prop-12345",
  "apartment_id": "apt-67890",
  "user_id": "user-abc123",
  "permission_type": "face_recognition",
  "biometric_template_id": "face-xyz789",
  "valid_from": "2025-01-07T00:00:00Z",
  "valid_until": "2025-12-31T23:59:59Z",
  "access_level": "resident"
}
```

#### 4.2.2. Партнёр "Умный дом" → PropDevelopment

**Типы событий (Webhook/Events)**:

1. **События доступа**
   - `access.granted` - доступ предоставлен (успешное распознавание)
   - `access.denied` - доступ отклонён (неуспешное распознавание)
   - `access.requested` - запрос на доступ (звонок на домофон)

2. **События распознавания**
   - `face.recognized` - успешное распознавание лица
   - `face.not_recognized` - лицо не распознано
   - `plate.recognized` - успешное распознавание номера автомобиля
   - `plate.not_recognized` - номер не распознан

3. **События устройств**
   - `device.status_changed` - изменение статуса устройства
   - `device.error` - ошибка устройства

**Формат событий**:
- **Протокол**: HTTPS POST
- **Content-Type**: `application/json`
- **Аутентификация**: подпись запроса (HMAC-SHA256) или Bearer Token

**Пример события**:
```json
POST https://propdev.example.com/api/v1/smart-home/events
X-Signature: {hmac_signature}
Content-Type: application/json

{
  "event_type": "access.granted",
  "event_id": "evt-123456",
  "timestamp": "2025-01-07T10:30:00Z",
  "device_id": "device-abc123",
  "device_type": "intercom",
  "property_id": "prop-12345",
  "apartment_id": "apt-67890",
  "user_id": "user-abc123",
  "recognition_method": "face_recognition",
  "confidence": 0.95
}
```

### 4.3. Синхронизация данных

#### 4.3.1. Начальная синхронизация
- При подключении нового объекта недвижимости к сервису
- Загрузка списка устройств и их текущих настроек
- Синхронизация существующих разрешений доступа

#### 4.3.2. Инкрементальная синхронизация
- Регулярная синхронизация изменений (каждые 15 минут)
- Синхронизация по событиям (real-time через webhooks)
- Обработка конфликтов при расхождении данных

#### 4.3.3. Обработка расхождений
- **Стратегия разрешения конфликтов**: последнее изменение имеет приоритет (Last Write Wins)
- **Логирование конфликтов**: все конфликты должны логироваться для аудита
- **Уведомления**: уведомление администраторов о критических расхождениях

### 4.4. Обработка ошибок

#### 4.4.1. Коды ошибок HTTP
- `400 Bad Request` - некорректный запрос
- `401 Unauthorized` - ошибка аутентификации
- `403 Forbidden` - недостаточно прав доступа
- `404 Not Found` - ресурс не найден
- `429 Too Many Requests` - превышен лимит запросов
- `500 Internal Server Error` - внутренняя ошибка сервера партнёра
- `503 Service Unavailable` - сервис временно недоступен

#### 4.4.2. Формат ответа об ошибке
```json
{
  "error": {
    "code": "INVALID_PERMISSION",
    "message": "Permission not found or access denied",
    "details": {
      "permission_id": "perm-12345",
      "reason": "Permission expired"
    },
    "timestamp": "2025-01-07T10:30:00Z",
    "request_id": "req-abc123"
  }
}
```

#### 4.4.3. Стратегия обработки ошибок
- **Retry**: автоматические повторы для временных ошибок (5xx)
- **Exponential backoff**: экспоненциальная задержка между повторами
- **Circuit breaker**: разрыв соединения при множественных ошибках
- **Fallback**: использование резервных механизмов при недоступности API

### 4.5. Версионирование API

#### 4.5.1. Стратегия версионирования
- **URL-based versioning**: `/api/v1/`, `/api/v2/`
- **Поддержка нескольких версий**: минимум 2 последние версии
- **Уведомление об устаревании**: минимум 6 месяцев до отключения версии

#### 4.5.2. Обратная совместимость
- Новые версии должны поддерживать обратную совместимость
- Устаревшие поля помечаются как deprecated
- Миграционный период для перехода на новую версию

### 4.6. Производительность и масштабируемость

#### 4.6.1. Требования к производительности
- **Время отклика API**: среднее < 500 мс, p95 < 1 сек
- **Пропускная способность**: минимум 1000 запросов/сек
- **Обработка событий**: задержка обработки событий < 5 сек

#### 4.6.2. Оптимизация
- **Кэширование**: кэширование часто запрашиваемых данных (списки разрешений, статусы устройств)
- **Батчинг**: группировка запросов для уменьшения количества вызовов API
- **Асинхронная обработка**: обработка некритичных операций асинхронно

---

## 5. Соответствие требованиям

### 5.1. Соответствие 152-ФЗ "О персональных данных"
- Получение согласия на обработку биометрических данных
- Обеспечение конфиденциальности персональных данных
- Уведомление Роскомнадзора о начале обработки биометрических данных
- Заключение договора с партнёром как оператором ПДн

### 5.2. Соответствие ISO/IEC 27001/27002
- Управление доступом (A.9)
- Криптография (A.10)
- Безопасность сетей (A.13)
- Управление инцидентами (A.16)
- Безопасность операций (A.12)

### 5.3. Соответствие требованиям безопасности
- Регулярные аудиты безопасности
- Пентесты интеграции
- Обновление протоколов и библиотек
- Мониторинг уязвимостей

---

## 6. Контрольный список внедрения

### 6.1. Подготовка
- [ ] Получение API документации от партнёра
- [ ] Получение тестовых credentials (Client ID, Client Secret)
- [ ] Настройка тестового окружения
- [ ] Проверка доступности API endpoints

### 6.2. Разработка
- [ ] Реализация OAuth 2.0 клиента
- [ ] Реализация API клиента для управления доступом
- [ ] Реализация обработчика webhook событий
- [ ] Реализация синхронизации данных
- [ ] Реализация обработки ошибок и retry механизма

### 6.3. Безопасность
- [ ] Настройка TLS 1.2+ для всех соединений
- [ ] Настройка хранения секретов (Vault/Secrets Manager)
- [ ] Реализация подписи запросов (HMAC)
- [ ] Настройка логирования и аудита
- [ ] Настройка мониторинга безопасности

### 6.4. Тестирование
- [ ] Unit тесты для всех компонентов
- [ ] Integration тесты с тестовым API партнёра
- [ ] Тесты безопасности (penetration testing)
- [ ] Нагрузочное тестирование
- [ ] Тестирование обработки ошибок и восстановления

### 6.5. Развёртывание
- [ ] Развёртывание в pre-production окружении
- [ ] Проведение UAT (User Acceptance Testing)
- [ ] Получение production credentials
- [ ] Развёртывание в production
- [ ] Мониторинг после развёртывания

---

## 7. Контакты и поддержка

**Ответственный за интеграцию в PropDevelopment**: [указать контакты]  
**Техническая поддержка партнёра**: [указать контакты]  
**Документация API партнёра**: [указать URL]

---

**Версия документа**: 1.0  
**Дата последнего обновления**: 2025-01-07  
**Статус**: Черновик

